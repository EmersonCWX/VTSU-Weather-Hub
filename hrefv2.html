<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HREFv2 Ensemble Forecast Viewer - VTSU Weather Center</title>
    <style>
        :root {
            --vtsu-turquoise: #00A5B3;
            --vtsu-red: #EC3754;
            --dark-gray: #1a1a1a;
            --white: #ffffff;
            --light-gray: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background: var(--dark-gray);
            color: var(--white);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--light-gray);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: #000000;
            color: var(--white);
            padding: 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            flex: 1;
            text-align: center;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid var(--white);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .content {
            padding: 30px;
        }

        .status-info {
            background: var(--dark-gray);
            border-left: 4px solid var(--vtsu-turquoise);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-info.loading {
            background: var(--dark-gray);
            color: var(--vtsu-turquoise);
        }

        .status-info.error {
            background: var(--dark-gray);
            border-left-color: var(--vtsu-red);
            color: var(--vtsu-red);
        }

        .status-info.success {
            background: var(--dark-gray);
            border-left-color: var(--vtsu-turquoise);
            color: var(--white);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--vtsu-turquoise);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select, input {
            background: var(--dark-gray);
            color: var(--white);
            border: 1px solid var(--light-gray);
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        select:hover, input:hover {
            border-color: var(--vtsu-turquoise);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--vtsu-turquoise);
            box-shadow: 0 0 0 2px rgba(0, 165, 179, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: auto;
        }

        button {
            flex: 1;
            background: var(--vtsu-turquoise);
            color: var(--dark-gray);
            border: none;
            padding: 10px 16px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: var(--vtsu-red);
        }

        button:disabled {
            background: var(--light-gray);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .viewer {
            background: var(--dark-gray);
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .viewer img {
            max-width: 100%;
            max-height: 600px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .viewer.loading::after {
            content: "Loading forecast product...";
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .info-text {
            font-size: 13px;
            color: #999;
            margin-top: 15px;
            text-align: center;
            line-height: 1.6;
        }

        .footer {
            background: var(--dark-gray);
            border-top: 1px solid var(--light-gray);
            padding: 15px 30px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .footer em {
            display: block;
            margin: 5px 0;
            font-style: italic;
            font-size: 11px;
        }

        .cycle-info {
            background: var(--dark-gray);
            border: 1px solid var(--light-gray);
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .cycle-info div {
            display: flex;
            justify-content: space-between;
        }

        .cycle-info strong {
            color: var(--vtsu-turquoise);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">‚Üê Back</a>
            <h1>HREFv2 Ensemble Forecast Viewer</h1>
            <div style="width: 100px;"></div>
        </div>

        <div class="content">
            <div class="status-info success" id="statusInfo">
                Initializing viewer... fetching latest forecast cycle information.
            </div>

            <div class="cycle-info" id="cycleInfo">
                <div>
                    <span>Latest Model Cycle:</span>
                    <strong id="latestCycle">--</strong>
                </div>
                <div>
                    <span>Data Source:</span>
                    <strong>NOMADS / NOAA</strong>
                </div>
            </div>

            <div class="controls">
                <div class="control-group">
                    <label for="region">Region</label>
                    <select id="region">
                        <option value="conus">CONUS</option>
                        <option value="ak">Alaska</option>
                        <option value="hi">Hawaii</option>
                        <option value="pr">Puerto Rico</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="product">Product</label>
                    <select id="product">
                        <option value="mean_500mb">500mb Mean Height</option>
                        <option value="mean_surface">Surface Temperature Mean</option>
                        <option value="mean_precip">Precipitation Mean</option>
                        <option value="prob_extreme">Extreme Probability</option>
                        <option value="sprd">Ensemble Spread</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="forecast">Forecast Hour</label>
                    <select id="forecast">
                        <option value="f01">F01 (1 hr)</option>
                        <option value="f04">F04 (4 hrs)</option>
                        <option value="f12" selected>F12 (12 hrs)</option>
                        <option value="f24">F24 (24 hrs)</option>
                        <option value="f36">F36 (36 hrs)</option>
                        <option value="f48">F48 (48 hrs)</option>
                    </select>
                </div>
            </div>

            <div class="button-group">
                <button id="loadBtn" onclick="loadForecast()">Load Forecast</button>
                <button id="refreshBtn" onclick="refreshCycle()">Refresh Cycle Info</button>
            </div>

            <div class="viewer" id="viewer">
                <div style="text-align: center;">
                    <strong>Welcome to HREFv2 Viewer</strong>
                    <p class="info-text">
                        This viewer provides access to NOAA's High-Resolution Ensemble Forecast (HREFv2) model.<br>
                        Select a region, product, and forecast hour above to view the latest ensemble mean predictions.
                    </p>
                </div>
            </div>
        </div>

        <div class="footer">
            Data Provided by <strong>NOAA / NCEP</strong> via NOMADS
            <em>High-Resolution Ensemble Forecast (HREFv2) model - Experimental Product</em>
        </div>
    </div>

    <script>
        // Get latest HREF model cycle
        async function getLatestCycle() {
            try {
                const response = await fetch('https://nomads.ncep.noaa.gov/pub/data/nccf/com/href/prod/', 
                    { method: 'HEAD', mode: 'no-cors' });
                // NOMADS doesn't provide easy cycle listing, so we'll use today's date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                
                // Cycles run at 00Z, 06Z, 12Z, 18Z
                const hour = now.getUTCHours();
                let cycle = Math.floor(hour / 6) * 6;
                if (hour < 6) cycle = 18; // Previous day's 18Z
                
                const cycleHour = String(cycle).padStart(2, '0');
                const cycleDate = cycle < 6 ? 
                    new Date(now.getTime() - 86400000).toISOString().split('T')[0].replace(/-/g, '') :
                    dateStr;
                
                return `${cycleDate}t${cycleHour}z`;
            } catch (e) {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                return `${dateStr}t00z`;
            }
        }

        async function refreshCycle() {
            try {
                document.getElementById('statusInfo').className = 'status-info loading';
                document.getElementById('statusInfo').textContent = 'Fetching latest model cycle...';
                
                const cycle = await getLatestCycle();
                const cycleFormatted = `${cycle.slice(0,4)}-${cycle.slice(4,6)}-${cycle.slice(6,8)} ${cycle.slice(9,11)}Z`;
                
                document.getElementById('latestCycle').textContent = cycleFormatted;
                document.getElementById('statusInfo').className = 'status-info success';
                document.getElementById('statusInfo').textContent = `Latest HREF cycle: ${cycleFormatted}`;
            } catch (e) {
                document.getElementById('statusInfo').className = 'status-info error';
                document.getElementById('statusInfo').textContent = 'Fembussy is Loaded [Data is unreachable]';
            }
        }

        function loadForecast() {
            const statusInfo = document.getElementById('statusInfo');
            statusInfo.className = 'status-info loading';
            statusInfo.textContent = 'Loading forecast product...';

            try {
                const region = document.getElementById('region').value;
                const product = document.getElementById('product').value;
                const forecast = document.getElementById('forecast').value;
                
                // Map product selector to product code
                const productMap = {
                    'mean_500mb': { code: 'mean', var: '500mb' },
                    'mean_surface': { code: 'mean', var: 'surface' },
                    'mean_precip': { code: 'mean', var: 'precip' },
                    'prob_extreme': { code: 'prob', var: 'extreme' },
                    'sprd': { code: 'sprd', var: '' }
                };

                const prod = productMap[product];
                if (!prod) {
                    throw new Error('Invalid product selection');
                }
                
                // Build NOMADS file URL
                // Format: href.t{cycle}z.{region}.{product}.{forecast}.grib2
                const nowUtc = new Date();
                let cycle = Math.floor(nowUtc.getUTCHours() / 6) * 6;
                if (cycle >= 6) {
                    const dateStr = nowUtc.toISOString().split('T')[0].replace(/-/g, '');
                    const cycleHour = String(cycle).padStart(2, '0');
                    const nomadsUrl = `https://nomads.ncep.noaa.gov/pub/data/nccf/com/href/prod/href.${dateStr}/ensprod/href.t${cycleHour}z.${region}.${prod.code}.${forecast}.grib2`;
                    
                    showProductInfo(product, region, forecast, nomadsUrl);
                } else {
                    const yesterday = new Date(nowUtc.getTime() - 86400000);
                    const dateStr = yesterday.toISOString().split('T')[0].replace(/-/g, '');
                    const cycleHour = '18';
                    const nomadsUrl = `https://nomads.ncep.noaa.gov/pub/data/nccf/com/href/prod/href.${dateStr}/ensprod/href.t${cycleHour}z.${region}.${prod.code}.${forecast}.grib2`;
                    
                    showProductInfo(product, region, forecast, nomadsUrl);
                }

                statusInfo.className = 'status-info success';
                statusInfo.textContent = 'Forecast loaded.';
            } catch (e) {
                statusInfo.className = 'status-info error';
                statusInfo.textContent = 'Fembussy is full please replace';
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = `
                    <div style="text-align: center; line-height: 1.8;">
                        <strong style="font-size: 16px; color: var(--vtsu-red);">Fembussy is full please replace</strong>
                    </div>
                `;
            }
        }

        function showProductInfo(product, region, forecast, nomadsUrl) {
            const viewer = document.getElementById('viewer');
            const regionNames = {
                'conus': 'Continental US',
                'ak': 'Alaska',
                'hi': 'Hawaii',
                'pr': 'Puerto Rico'
            };
            
            const productNames = {
                'mean_500mb': '500mb Mean Height',
                'mean_surface': 'Surface Temperature Mean',
                'mean_precip': 'Precipitation Mean',
                'prob_extreme': 'Extreme Probability',
                'sprd': 'Ensemble Spread'
            };

            const forecastHour = forecast.slice(1); // Remove 'f' prefix

            viewer.innerHTML = `
                <div style="text-align: center; line-height: 1.8;">
                    <strong style="font-size: 16px; color: var(--vtsu-turquoise);">
                        ${productNames[product]} - ${regionNames[region]}
                    </strong>
                    <p style="margin: 15px 0; color: #999; font-size: 13px;">
                        Forecast Hour: <strong>${forecastHour}</strong>
                    </p>
                </div>
            `;
        }

        function getProductId(product) {
            const map = {
                'mean_500mb': '500mb_mean',
                'mean_surface': 'sfctemp_mean',
                'mean_precip': 'apcp_mean',
                'prob_extreme': 'extreme_prob',
                'sprd': 'spread'
            };
            return map[product] || '500mb_mean';
        }

        function getRegionId(region) {
            const map = {
                'conus': 'conus',
                'ak': 'alaska',
                'hi': 'hawaii',
                'pr': 'carib'
            };
            return map[region] || 'conus';
        }

        function downloadGRIB(url) {
            window.open(url, '_blank');
        }

        // Initialize on page load
        window.addEventListener('load', refreshCycle);
    </script>
</body>
</html>
