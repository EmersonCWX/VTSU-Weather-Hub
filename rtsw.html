<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Solar Wind - RTSW | VTSU Weather Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        :root {
            --vtsu-turquoise: #00A5B3;
            --vtsu-red: #EC3754;
            --dark-gray: #1a1a1a;
            --white: #ffffff;
            --clock-bg: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-gray);
            color: var(--white);
            display: flex;
            flex-direction: column;
        }

        .top-nav {
            background-color: var(--dark-gray);
            width: 100%;
            padding: 0.8rem 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .nav-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--white);
            text-align: center;
        }

        .back-btn {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: 1px solid var(--white);
            color: var(--white);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }

        .chart-wrapper {
            width: 95%;
            max-width: 1200px;
            height: 760px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(0, 165, 179, 0.3);
            border-radius: 8px;
            padding: 2rem 2rem 3rem 2rem;
            position: relative;
        }

        .chart-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100%;
        }

        .panel {
            flex: 1;
            min-height: 110px;
            position: relative;
        }

        .panel.kp-panel {
            flex: 1.8;
            min-height: 190px;
        }

        .panel canvas {
            width: 100%;
            height: 100%;
        }

        .info-bottom {
            position: absolute;
            bottom: 10px;
            width: calc(100% - 2rem);
            display: flex;
            justify-content: space-between;
            padding: 0 1rem;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .last-update-left {
            text-align: left;
        }

        .credit-right {
            text-align: right;
            color: var(--vtsu-turquoise);
        }

        .loading {
            display: none;
            font-size: 1.2rem;
            color: var(--vtsu-turquoise);
        }

        .error {
            display: none;
            color: var(--vtsu-red);
            font-size: 1.1rem;
            text-align: center;
        }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .nav-title {
                font-size: 1rem;
            }

            .back-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .container {
                padding: 1rem;
            }

            .chart-wrapper {
                height: 600px;
                padding: 1.5rem 1.5rem 2.5rem 1.5rem;
            }

            .panel {
                min-height: 90px;
            }

            .info-bottom {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .nav-title {
                font-size: 0.9rem;
            }

            .back-btn {
                padding: 5px 10px;
                font-size: 11px;
                left: 0.5rem;
            }

            .container {
                padding: 0.75rem;
            }

            .chart-wrapper {
                height: auto;
                min-height: 100vh;
                padding: 1rem 1rem 2rem 1rem;
                width: 100%;
                border-radius: 6px;
            }

            .chart-stack {
                gap: 20px;
            }

            .panel {
                min-height: 120px;
            }

            .panel canvas {
                width: 100%;
                height: 100%;
            }

            .info-bottom {
                font-size: 0.7rem;
                bottom: 8px;
                width: calc(100% - 1rem);
                padding: 0 0.5rem;
            }

            .loading {
                font-size: 1rem;
            }

            .error {
                font-size: 0.95rem;
            }
        }

        @media (max-width: 480px) {
            .top-nav {
                padding: 0.6rem 0.5rem;
            }

            .nav-title {
                font-size: 0.8rem;
            }

            .back-btn {
                padding: 4px 8px;
                font-size: 10px;
                left: 0.25rem;
            }

            .container {
                padding: 0.5rem;
            }

            .chart-wrapper {
                height: auto;
                min-height: 100vh;
                padding: 0.75rem 0.75rem 1.5rem 0.75rem;
                width: 100%;
                border-radius: 4px;
            }

            .chart-stack {
                gap: 20px;
            }

            .panel {
                min-height: 100px;
            }

            .info-bottom {
                font-size: 0.65rem;
                bottom: 6px;
                width: calc(100% - 0.75rem);
                padding: 0 0.375rem;
                flex-direction: column;
                gap: 4px;
            }

            .last-update-left,
            .credit-right {
                text-align: center;
            }

            .loading {
                font-size: 0.9rem;
            }

            .error {
                font-size: 0.85rem;
            }
        }

    </style>
</head>
<body>
    <nav class="top-nav">
        <a href="index.html" class="back-btn">‚Üê Back</a>
        <div class="nav-title">Real-Time Solar Wind - RTSW</div>
    </nav>

    <div class="container">
        <div class="loading" id="loading">Loading real-time solar wind data...</div>
        <div class="error" id="error"></div>

        <div class="chart-wrapper" id="chartWrapper" style="display: none;">
            <div class="chart-stack">
                <div class="panel">
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; text-align: center;">Current Bz: <span id="currentBz" style="color: #ff4d4d; font-weight: bold;">-- nT</span></div>
                    <canvas id="magChart"></canvas>
                </div>
                <div class="panel"><canvas id="phiChart"></canvas></div>
                <div class="panel kp-panel">
                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.7); margin-bottom: 8px; text-align: center;">Current Kp: <span id="currentKp" style="color: #52d452; font-weight: bold;">-- </span></div>
                    <canvas id="kpChart"></canvas>
                </div>
                <div class="panel"><canvas id="speedChart"></canvas></div>
                <div class="panel"><canvas id="tempChart"></canvas></div>
            </div>
            <div class="info-bottom">
                <div class="last-update-left">Last Updated: <span id="updateTime">--:--:-- UTC</span></div>
                <div class="credit-right">Data Provided by SWPC</div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let updateInterval = null;

        async function fetchRtswData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const chartWrapper = document.getElementById('chartWrapper');

            try {
                loading.style.display = 'block';
                error.style.display = 'none';

                const windUrl = 'https://services.swpc.noaa.gov/json/rtsw/rtsw_wind_1m.json';
                const magUrl = 'https://services.swpc.noaa.gov/json/rtsw/rtsw_mag_1m.json';
                const kpUrl = 'https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json';
                const [windResponse, magResponse, kpResponse] = await Promise.all([
                    fetch(windUrl),
                    fetch(magUrl),
                    fetch(kpUrl)
                ]);

                if (!windResponse.ok || !magResponse.ok || !kpResponse.ok) {
                    throw new Error(`HTTP error! status: ${!windResponse.ok ? windResponse.status : magResponse.ok ? kpResponse.status : magResponse.status}`);
                }

                const windData = await windResponse.json();
                const magData = await magResponse.json();
                const kpData = await kpResponse.json();

                const timeLabels = [];
                const speedData = [];
                const kpIndexData = [];
                const tempData = [];
                const btData = [];
                const bzData = [];
                const phiData = [];

                const magMap = {};
                magData.forEach(point => {
                    magMap[point.time_tag] = {
                        bt: point.bt,
                        bz: Array.isArray(point.bz_gsm) ? point.bz_gsm[0] : point.bz_gsm,
                        phi: point.phi_gsm
                    };
                });

                windData.forEach(point => {
                    const timeLabel = new Date(point.time_tag).toLocaleTimeString('en-US', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    timeLabels.push(timeLabel);
                    speedData.push(point.proton_speed);
                    tempData.push(point.proton_temperature);
                    if (magMap[point.time_tag]) {
                        btData.push(magMap[point.time_tag].bt);
                        bzData.push(magMap[point.time_tag].bz);
                        phiData.push(magMap[point.time_tag].phi);
                    } else {
                        btData.push(null);
                        bzData.push(null);
                        phiData.push(null);
                    }
                });

                // Process Kp data into 3-hour intervals
                const kpIndexMap = {};
                // Skip header row if present
                const kpDataArray = Array.isArray(kpData) ? kpData : [];
                kpDataArray.forEach((point, index) => {
                    // Skip the header row (first element)
                    if (index === 0 && (typeof point[0] === 'string' && point[0].toLowerCase().includes('time'))) {
                        return;
                    }
                    
                    // Format is typically: ["2024-01-15 03:00:00.000", "4"]
                    const timeString = Array.isArray(point) ? point[0] : point.time_tag;
                    const kpValue = parseFloat(Array.isArray(point) ? point[1] : point.kp_index);
                    
                    if (!timeString || isNaN(kpValue)) return;
                    
                    const date = new Date(timeString);
                    const hour = date.getUTCHours();
                    const threeHourIndex = Math.floor(hour / 3);
                    const key = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}_${threeHourIndex}`;
                    
                    if (!kpIndexMap[key]) {
                        kpIndexMap[key] = [];
                    }
                    kpIndexMap[key].push(kpValue);
                });

                // Get last 16 3-hour periods (48 hours before current time)
                const now = new Date();
                for (let i = 15; i >= 0; i--) {
                    const date = new Date(now);
                    date.setUTCHours(date.getUTCHours() - (i * 3));
                    const threeHourIndex = Math.floor(date.getUTCHours() / 3);
                    const key = `${date.getUTCFullYear()}-${String(date.getUTCMonth() + 1).padStart(2, '0')}-${String(date.getUTCDate()).padStart(2, '0')}_${threeHourIndex}`;
                    const startHour = threeHourIndex * 3;
                    
                    const hourLabel = String(startHour).padStart(2, '0') + ':00';
                    const kpValues = kpIndexMap[key] || [];
                    const avgKp = kpValues.length > 0 ? Math.round(kpValues.reduce((a, b) => a + b, 0) / kpValues.length * 10) / 10 : 0;
                    
                    kpIndexData.push(avgKp);
                    // Rebuild timeLabels with proper 3-hour intervals if they don't match
                }

                // Rebuild time labels for Kp data (3-hour intervals)
                const kpTimeLabels = [];
                for (let i = 15; i >= 0; i--) {
                    const date = new Date(now);
                    date.setUTCHours(date.getUTCHours() - (i * 3));
                    const startHour = Math.floor(date.getUTCHours() / 3) * 3;
                    const dayLabel = date.getUTCDate();
                    kpTimeLabels.push(`${String(startHour).padStart(2, '0')}:00`);
                }

                updateChart(timeLabels, speedData, kpIndexData, kpTimeLabels, tempData, btData, bzData, phiData);

                const utcTime = now.toISOString().split('T')[1].substring(0, 8);
                document.getElementById('updateTime').textContent = `${utcTime} UTC`;

                chartWrapper.style.display = 'block';
                loading.style.display = 'none';

            } catch (err) {
                console.error('Failed to fetch RTSW data:', err);
                error.style.display = 'block';
                error.textContent = `Error loading data: ${err.message}`;
                loading.style.display = 'none';
            }
        }

        function updateChart(timeLabels, speedData, kpIndexData, kpTimeLabels, tempData, btData, bzData, phiData) {
            Object.values(charts).forEach(existing => existing.destroy());
            charts = {};

            // Update current Bz value with color coding
            const currentBzValue = bzData[bzData.length - 1];
            const currentBzEl = document.getElementById('currentBz');
            if (currentBzValue !== undefined) {
                currentBzEl.textContent = currentBzValue.toFixed(1) + ' nT';
                currentBzEl.style.color = currentBzValue < 0 ? '#ff4d4d' : '#52d452'; // Red for South, Green for North
            } else {
                currentBzEl.textContent = '-- nT';
                currentBzEl.style.color = '#ff4d4d';
            }

            // Update current Kp value with color coding based on geomagnetic conditions
            const currentKpValue = kpIndexData[kpIndexData.length - 1];
            const currentKpEl = document.getElementById('currentKp');
            const getKpColor = (value) => {
                if (value < 5) return '#52d452';      // Green: < 5
                if (value < 6) return '#ffd500';      // Yellow: 5
                if (value < 7) return '#ff9500';      // Orange: 6
                if (value < 8) return '#ff4444';      // Red: 7
                return '#8b0000';                     // Dark Red: 8-9
            };
            if (currentKpValue !== undefined) {
                currentKpEl.textContent = currentKpValue.toFixed(1);
                currentKpEl.style.color = getKpColor(currentKpValue);
            } else {
                currentKpEl.textContent = '-- ';
                currentKpEl.style.color = '#52d452';
            }

            const baseOptions = (showXAxis, yTitle) => {
                const isMobile = window.innerWidth <= 768;
                const legendFontSize = window.innerWidth <= 480 ? 8 : isMobile ? 9 : 11;
                const tickFontSize = window.innerWidth <= 480 ? 7 : isMobile ? 8 : 10;
                const titleFontSize = window.innerWidth <= 480 ? 9 : isMobile ? 10 : 12;
                
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, labels: { color: '#ffffff', font: { size: legendFontSize, weight: 'bold' } } }
                    },
                    scales: {
                        x: {
                            display: showXAxis,
                            ticks: { color: 'rgba(255, 255, 255, 0.6)', maxTicksLimit: 10, font: { size: tickFontSize } },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' }
                        },
                        y: {
                            display: true,
                            ticks: { color: 'rgba(255, 255, 255, 0.6)', font: { size: tickFontSize } },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            title: { display: true, text: yTitle, color: '#ffffff', font: { size: titleFontSize } }
                        }
                    }
                };
            };

            const lineStyle = (color) => ({
                borderColor: color,
                backgroundColor: 'transparent',
                borderWidth: 1,
                tension: 0.2,
                pointRadius: 0,
                pointBackgroundColor: color,
                fill: false
            });

            charts.mag = new Chart(document.getElementById('magChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'Bt (nT)', data: btData, ...lineStyle('#e5e7eb') },
                        { label: 'Bz GSM (nT)', data: bzData, ...lineStyle('#ff4d4d') }
                    ]
                },
                options: baseOptions(false, 'Bt / Bz (nT)')
            });

            charts.phi = new Chart(document.getElementById('phiChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'Phi GSM (deg)', data: phiData, ...lineStyle('#67b7ff') }
                    ]
                },
                options: baseOptions(false, 'Phi GSM (deg)')
            });

            const kpColors = kpIndexData.map(value => getKpColor(value));

            charts.kp = new Chart(document.getElementById('kpChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: kpTimeLabels,
                    datasets: [
                        {
                            label: 'Kp Index (3hr avg)',
                            data: kpIndexData,
                            backgroundColor: kpColors,
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart',
                        delay: (context) => {
                            let delay = 0;
                            if (context.type === 'data' && context.mode === 'default') {
                                delay = context.dataIndex * 50;
                            }
                            return delay;
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true,
                            labels: { color: '#ffffff', font: { size: window.innerWidth <= 480 ? 8 : window.innerWidth <= 768 ? 9 : 11, weight: 'bold' } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(1);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0,
                            max: 9,
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.6)', 
                                stepSize: 1,
                                autoSkip: false,
                                includeBounds: true,
                                font: { size: window.innerWidth <= 480 ? 7 : window.innerWidth <= 768 ? 8 : 10 } 
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            title: { display: true, text: 'Kp Index', color: '#ffffff', font: { size: window.innerWidth <= 480 ? 9 : window.innerWidth <= 768 ? 10 : 12 } }
                        },
                        x: {
                            display: true,
                            ticks: { 
                                color: 'rgba(255, 255, 255, 0.6)', 
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: false,
                                maxTicksLimit: 16,
                                font: { size: window.innerWidth <= 480 ? 6 : window.innerWidth <= 768 ? 7 : 9 } 
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.08)' },
                            title: { display: true, text: 'UTC Time (3-hour intervals)', color: '#ffffff', font: { size: window.innerWidth <= 480 ? 8 : window.innerWidth <= 768 ? 9 : 11 } }
                        }
                    },
                    layout: {
                        padding: {
                            left: 5,
                            right: 5,
                            bottom: 10
                        }
                    },
                    barPercentage: 0.85,
                    categoryPercentage: 0.9
                }
            });

            charts.speed = new Chart(document.getElementById('speedChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'Speed (km/s)', data: speedData, ...lineStyle('#b174ff') }
                    ]
                },
                options: baseOptions(false, 'Speed (km/s)')
            });

            charts.temp = new Chart(document.getElementById('tempChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [
                        { label: 'Temperature (K)', data: tempData, ...lineStyle('#52d452') }
                    ]
                },
                options: baseOptions(true, 'Temperature (K)')
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            fetchRtswData();
        });


    </script>
</body>
</html>
